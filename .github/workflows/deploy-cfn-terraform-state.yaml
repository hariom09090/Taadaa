name: CloudFormation Plan and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read

env:
  AWS_REGION: ap-south-1
  CFN_FOLDER: Actions-CFN

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.diff.outputs.changed_files }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changed CFN Templates
        id: diff
        run: |
          files=$(git diff --name-only HEAD^ HEAD -- "${{ env.CFN_FOLDER }}/*.yaml" "${{ env.CFN_FOLDER }}/*.yml" | jq -R -s -c 'split("\n") | map(select(length>0))')
          echo "changed_files=$files" >> $GITHUB_OUTPUT

  plan:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.changed_files != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.detect-changes.outputs.changed_files) }}
    concurrency:
      group: cfn-plan-${{ matrix.file }}-${{ github.event.number }}
      cancel-in-progress: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CFN Template
        run: |
          aws cloudformation validate-template --template-body file://${{ matrix.file }}

      - name: Check Stack Existence and Create Change Set
        id: change-set
        run: |
          TEMPLATE="${{ matrix.file }}"
          STACK=$(basename "$TEMPLATE" .yaml | sed 's/\.yml$//')
          echo "STACK_NAME=$STACK" >> $GITHUB_ENV
          CHANGE_SET_NAME="${STACK}-pr-${{ github.event.number }}"
          
          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name "$STACK" --region "${{ env.AWS_REGION }}" >/dev/null 2>&1; then
            CHANGE_SET_TYPE="UPDATE"
            echo "Stack $STACK exists. Creating UPDATE change set."
          else
            CHANGE_SET_TYPE="CREATE"
            echo "Stack $STACK does not exist. Creating CREATE change set."
          fi
          
          # Delete existing change set if it exists
          if aws cloudformation describe-change-set --stack-name "$STACK" --change-set-name "$CHANGE_SET_NAME" --region "${{ env.AWS_REGION }}" >/dev/null 2>&1; then
            aws cloudformation delete-change-set --stack-name "$STACK" --change-set-name "$CHANGE_SET_NAME" --region "${{ env.AWS_REGION }}"
          fi
          
          # Create change set
          aws cloudformation create-change-set \
            --stack-name "$STACK" \
            --change-set-name "$CHANGE_SET_NAME" \
            --template-body file://"$TEMPLATE" \
            --capabilities CAPABILITY_NAMED_IAM \
            --region "${{ env.AWS_REGION }}" \
            --change-set-type "$CHANGE_SET_TYPE"
          
          # Wait for change set to be ready
          aws cloudformation wait change-set-create-complete \
            --stack-name "$STACK" \
            --change-set-name "$CHANGE_SET_NAME" \
            --region "${{ env.AWS_REGION }}" || true
          
          # Describe change set
          CHANGE_SET_DETAILS=$(aws cloudformation describe-change-set \
            --stack-name "$STACK" \
            --change-set-name "$CHANGE_SET_NAME" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Changes[].ResourceChange.{Action:Action,LogicalResourceId:LogicalResourceId,ResourceType:ResourceType,Replacement:Replacement}' \
            --output json | jq -c .)
          echo "CHANGE_SET_DETAILS=$CHANGE_SET_DETAILS" >> $GITHUB_ENV
          echo "CHANGE_SET_TYPE=$CHANGE_SET_TYPE" >> $GITHUB_ENV

      - name: Comment on PR with Change Set Details
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const details = JSON.parse(process.env.CHANGE_SET_DETAILS);
            const stackName = process.env.STACK_NAME;
            const templatePath = "${{ matrix.file }}";
            const changeSetType = process.env.CHANGE_SET_TYPE;
            let changesTable = '| Action | LogicalResourceId | ResourceType | Replacement |\n';
            changesTable += '|--------|-------------------|--------------|-------------|\n';
            for (const change of details) {
              changesTable += `| ${change.Action} | ${change.LogicalResourceId} | ${change.ResourceType} | ${change.Replacement || 'N/A'} |\n`;
            }
            const body = `
            ### CloudFormation Change Set
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`  
            **Change Set Type:** \`${changeSetType}\`  
            **Changes:**
            ${changesTable}
            `;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Comment on PR with Failure Details
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const stackName = process.env.STACK_NAME || 'Unknown';
            const templatePath = "${{ matrix.file }}";
            const body = `
            ### ❌ CloudFormation Change Set Creation Failed
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`  
            **Error:** Check the GitHub Actions logs for details.
            `;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

  deploy:
    needs: detect-changes
    if: github.event_name == 'push' && needs.detect-changes.outputs.changed_files != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.detect-changes.outputs.changed_files) }}
    concurrency:
      group: cfn-deploy-${{ matrix.file }}
      cancel-in-progress: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Extract PR Number
        id: extract-pr
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ $COMMIT_MSG =~ Merge\ pull\ request\ \#([0-9]+) ]]; then
            echo "pr_number=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy CFN Stack
        id: deploy
        run: |
          TEMPLATE="${{ matrix.file }}"
          STACK=$(basename "$TEMPLATE" .yaml | sed 's/\.yml$//')
          echo "STACK_NAME=$STACK" >> $GITHUB_ENV
          
          # Check stack status
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --region "${{ env.AWS_REGION }}" \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
            aws cloudformation delete-stack --stack-name "$STACK" --region "${{ env.AWS_REGION }}"
            aws cloudformation wait stack-delete-complete --stack-name "$STACK" --region "${{ env.AWS_REGION }}"
          fi
          
          aws cloudformation deploy \
            --template-file "$TEMPLATE" \
            --stack-name "$STACK" \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset \
            --region "${{ env.AWS_REGION }}"

      - name: Comment on PR with Deployment Success
        if: success() && steps.extract-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.extract-pr.outputs.pr_number }};
            const stackName = process.env.STACK_NAME;
            const templatePath = "${{ matrix.file }}";
            const body = `
            ### ✅ CloudFormation Deployment Successful
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`  
            The stack has been successfully deployed.
            `;
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Comment on PR with Deployment Failure
        if: failure() && steps.extract-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.extract-pr.outputs.pr_number }};
            const stackName = process.env.STACK_NAME;
            const templatePath = "${{ matrix.file }}";
            const error = await (async () => {
              try {
                return await exec('aws cloudformation describe-stack-events --stack-name "' + stackName + '" --region "${{ env.AWS_REGION }}" --query "StackEvents[?ResourceStatus==\'CREATE_FAILED\' || ResourceStatus==\'UPDATE_FAILED\'][0].ResourceStatusReason" --output text');
              } catch (e) {
                return 'Unknown error';
              }
            })();
            const body = `
            ### ❌ CloudFormation Deployment Failed
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`  
            **Error:** \`${error}\`
            `;
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });