name: CloudFormation Plan and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read

env:
  AWS_REGION: ap-south-1
  CFN_FOLDER: Actions-CFN

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.diff.outputs.changed_files }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get Changed Files
        id: diff
        run: |
          echo "üïµÔ∏è Detecting CFN template changes..."
          files=$(git diff --name-only HEAD^ HEAD -- "${{ env.CFN_FOLDER }}/*.yaml" "${{ env.CFN_FOLDER }}/*.yml")
          echo "üìÑ Changed files:"
          echo "$files"
          if [ -z "$files" ]; then
            echo "changed_files=[]" >> $GITHUB_OUTPUT
          else
            json=$(echo "$files" | jq -R -s -c 'split("\n") | map(select(length>0))')
            echo "changed_files=$json" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed_files != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.detect-changes.outputs.changed_files) }}
    concurrency:
      group: cfn-${{ matrix.file }}
      cancel-in-progress: true

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      - name: Validate CFN Template ‚Äì ${{ matrix.file }}
        run: |
          echo "‚úÖ Validating CFN Template: ${{ matrix.file }}"
          aws cloudformation validate-template --template-body file://${{ matrix.file }}

      - name: Create Change Set for PR
        if: github.event_name == 'pull_request'
        env:
          PR_NUMBER: ${{ github.event.number }}
        run: |
          TEMPLATE="${{ matrix.file }}"
          echo "üìù Creating Change Set for PR: $TEMPLATE"
          if [ ! -f "$TEMPLATE" ]; then
            echo "‚ùå Template file $TEMPLATE does not exist"
            exit 1
          fi
          STACK=$(basename "$TEMPLATE" | sed -E 's/\.(yaml|yml)$//') || {
            echo "‚ùå Failed to extract stack name from $TEMPLATE"
            exit 1
          }
          echo "STACK_NAME=$STACK" >> $GITHUB_ENV || {
            echo "‚ùå Failed to set STACK_NAME in GITHUB_ENV"
            exit 1
          }
          CHANGE_SET_NAME="${STACK}-pr-${PR_NUMBER}" || {
            echo "‚ùå Failed to construct CHANGE_SET_NAME"
            exit 1
          }
          aws cloudformation describe-change-set --stack-name "$STACK" --change-set-name "$CHANGE_SET_NAME" --region "$AWS_REGION" 2>&1 | tee describe-change-set.log || {
            echo "‚ö†Ô∏è No existing change set $CHANGE_SET_NAME found or error occurred"
            cat describe-change-set.log
            # Continue, as change set not existing is expected
          }
          if [ $? -eq 0 ]; then
            echo "Deleting existing change set $CHANGE_SET_NAME"
            aws cloudformation delete-change-set --stack-name "$STACK" --change-set-name "$CHANGE_SET_NAME" --region "$AWS_REGION" 2>&1 | tee delete-change-set.log || {
              echo "‚ùå Failed to delete change set $CHANGE_SET_NAME"
              cat delete-change-set.log
              exit 1
            }
          fi
          STACK_EXISTS=$(aws cloudformation describe-stacks --stack-name "$STACK" --region "$AWS_REGION" --query "Stacks[0].StackName" --output text 2>&1 || echo "false") || {
            echo "‚ùå Failed to check stack existence for $STACK"
            exit 1
          }
          if [ "$STACK_EXISTS" != "false" ]; then
            STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK" --region "$AWS_REGION" --query "Stacks[0].StackStatus" --output text 2>&1 || echo "UNKNOWN") || {
              echo "‚ùå Failed to retrieve stack status for $STACK"
              exit 1
            }
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STATUS" = "ROLLBACK_FAILED" ]; then
              echo "‚ùå Stack $STACK is in $STATUS state and cannot be updated. Please delete the stack manually or handle this state."
              exit 1
            fi
          fi
          if [ "$STACK_EXISTS" == "false" ]; then
            echo "Creating new stack with change set $CHANGE_SET_NAME"
            aws cloudformation create-change-set \
              --stack-name "$STACK" \
              --change-set-name "$CHANGE_SET_NAME" \
              --template-body file://"$TEMPLATE" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region "$AWS_REGION" \
              --change-set-type CREATE 2>&1 | tee create-change-set.log || {
              echo "‚ùå Failed to create change set for CREATE"
              cat create-change-set.log
              exit 1
            }
          else
            echo "Updating existing stack with change set $CHANGE_SET_NAME"
            aws cloudformation create-change-set \
              --stack-name "$STACK" \
              --change-set-name "$CHANGE_SET_NAME" \
              --template-body file://"$TEMPLATE" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region "$AWS_REGION" \
              --change-set-type UPDATE 2>&1 | tee create-change-set.log || {
              echo "‚ùå Failed to create change set for UPDATE"
              cat create-change-set.log
              exit 1
            }
          fi
          aws cloudformation wait change-set-create-complete \
              --stack-name "$STACK" \
              --change-set-name "$CHANGE_SET_NAME" \
              --region "$AWS_REGION" 2>&1 | tee wait-change-set.log || {
              echo "‚ö†Ô∏è Change set creation failed or no changes detected."
              cat wait-change-set.log
              exit 0  # Allow continuation if no changes
            }
          CHANGE_SET_DETAILS=$(aws cloudformation describe-change-set \
              --stack-name "$STACK" \
              --change-set-name "$CHANGE_SET_NAME" \
              --region "$AWS_REGION" \
              --query "Changes[].ResourceChange" \
              --output json 2>&1 || echo "[]") || {
              echo "‚ùå Failed to describe change set $CHANGE_SET_NAME"
              exit 1
            }
          echo "CHANGE_SET_DETAILS<<EOF" >> $GITHUB_ENV || {
            echo "‚ùå Failed to set CHANGE_SET_DETAILS in GITHUB_ENV"
            exit 1
          }
          echo "$CHANGE_SET_DETAILS" >> $GITHUB_ENV || {
            echo "‚ùå Failed to write CHANGE_SET_DETAILS to GITHUB_ENV"
            exit 1
          }
          echo "EOF" >> $GITHUB_ENV || {
            echo "‚ùå Failed to complete CHANGE_SET_DETAILS in GITHUB_ENV"
            exit 1
          }

      - name: Comment on PR with Change Set Details
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changeSetDetails = process.env.CHANGE_SET_DETAILS;
            const stackName = "${{ env.STACK_NAME }}";
            const templatePath = "${{ matrix.file }}";
            const body = `
            ### CloudFormation Change Set Details
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`
            **Change Set Details:**
            \`\`\`json
            ${changeSetDetails}
            \`\`\`
            `;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Extract PR Number
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ $COMMIT_MSG =~ Merge\ pull\ request\ \#([0-9]+) ]]; then
            PR_NUMBER=${BASH_REMATCH[1]}
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          else
            echo "No PR number found in commit message."
          fi

      - name: Deploy CFN Stack ‚Äì ${{ matrix.file }}
        if: github.event_name == 'push'
        run: |
          TEMPLATE="${{ matrix.file }}"
          STACK=$(basename "$TEMPLATE" | sed -E 's/\.(yaml|yml)$//')
          echo "STACK_NAME=$STACK" >> $GITHUB_ENV
          echo "üöÄ Deploying stack '$STACK' from template '$TEMPLATE'..."
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK" \
            --region $AWS_REGION \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "NOT_FOUND")
          if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
            echo "‚ö†Ô∏è Stack in ROLLBACK_COMPLETE ‚Äì deleting before fresh deploy."
            aws cloudformation delete-stack --stack-name "$STACK" --region $AWS_REGION
            aws cloudformation wait stack-delete-complete --stack-name "$STACK" --region $AWS_REGION
          fi
          aws cloudformation deploy \
            --template-file "$TEMPLATE" \
            --stack-name "$STACK" \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
          echo "‚ú® Deployment complete for: $STACK"

      - name: Comment on PR with Deployment Success
        if: success() && github.event_name == 'push' && env.PR_NUMBER != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ env.PR_NUMBER }};
            const stackName = "${{ env.STACK_NAME }}";
            const templatePath = "${{ matrix.file }}";
            const body = `
            ### ‚úÖ CloudFormation Deployment Successful
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`
            The stack has been successfully deployed.
            `;
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Capture Deployment Error
        if: failure() && github.event_name == 'push'
        run: |
          STACK="${{ env.STACK_NAME }}"
          ERR=$(aws cloudformation describe-stack-events \
            --stack-name "$STACK" \
            --region $AWS_REGION \
            --query "StackEvents[?ResourceStatus=='CREATE_FAILED' || ResourceStatus=='UPDATE_FAILED'] | [0].ResourceStatusReason" \
            --output text 2>/dev/null || echo "Unknown error")
          echo "ERR=$ERR" >> $GITHUB_ENV

      - name: Comment on PR with Deployment Failure
        if: failure() && github.event_name == 'push' && env.PR_NUMBER != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ env.PR_NUMBER }};
            const stackName = "${{ env.STACK_NAME }}";
            const templatePath = "${{ matrix.file }}";
            const errorMessage = "${{ env.ERR }}";
            const body = `
            ### ‚ùå CloudFormation Deployment Failed
            **Stack:** \`${stackName}\`  
            **Template:** \`${templatePath}\`
            üö´ **Error:**
            \`\`\`
            ${errorMessage}
            \`\`\`
            Please review the deployment logs for more details.
            `;
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Dump CFN Error and Comment on PR (on Failure)
        if: failure() && github.event_name == 'pull_request'
        run: |
          echo "üß† Diagnosing CFN deployment failure..."
          if [ -z "${{ env.STACK_NAME }}" ]; then
            ERR="Stack name not set. Likely failed before stack creation."
          else
            ERR=$(aws cloudformation describe-stack-events \
              --stack-name "${{ env.STACK_NAME }}" \
              --region $AWS_REGION \
              --query "StackEvents[?ResourceStatus=='CREATE_FAILED'] | [0].ResourceStatusReason" \
              --output text 2>/dev/null || echo "Unknown error")
          fi
          echo "üí• Error: $ERR"
          echo "### ‚ùå CloudFormation Change Set Creation Failed" > comment.txt
          echo "**Stack:** \`${{ env.STACK_NAME }}\`" >> comment.txt
          echo "**Template:** \`${{ matrix.file }}\`" >> comment.txt
          echo "üö´ **Error:**" >> comment.txt
          echo "\`\`\`" >> comment.txt
          echo "$ERR" >> comment.txt
          echo "\`\`\`" >> comment.txt
          echo "Please review and adjust the template." >> comment.txt

      - name: Comment in PR (on Failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('comment.txt', 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });